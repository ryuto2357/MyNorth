(()=>{const t="mynorth_chat",e=document.getElementById("chatTextArea"),n=document.getElementById("sendButton"),a=document.getElementById("chatLogs"),s=document.getElementById("chatTabs"),i=document.getElementById("newTabBtn"),o=document.getElementById("themeToggle");function c(t){document.body.setAttribute("data-theme",t),localStorage.setItem("mynorth_theme",t),o.innerText="dark"===t?"â˜€ï¸":"ðŸŒ™"}function d(t){t.length>20&&t.splice(0,t.length-20)}function r(t){const e=document.createElement("div");return e.innerText=t,e.innerHTML}o.addEventListener("click",()=>{c("dark"===(document.body.getAttribute("data-theme")||"light")?"light":"dark")}),c(localStorage.getItem("mynorth_theme")||"light"),marked.setOptions({breaks:!0,mangle:!1,headerIds:!1});const l=function(){const e=localStorage.getItem(t);if(!e)return{version:2,activeTabId:"tab-1",tabs:{"tab-1":{title:"Chat 1",messages:[]}}};try{const t=(n=JSON.parse(e))&&2===n.version?n:Array.isArray(n)?{version:2,activeTabId:"tab-1",tabs:{"tab-1":{title:"Chat 1",messages:n}}}:{version:2,activeTabId:"tab-1",tabs:{"tab-1":{title:"Chat 1",messages:[]}}};return b(t),t}catch{return{version:2,activeTabId:"tab-1",tabs:{"tab-1":{title:"Chat 1",messages:[]}}}}var n}();function m(){return l.tabs[l.activeTabId]||(l.activeTabId=Object.keys(l.tabs)[0],b(l)),l.tabs[l.activeTabId]}function u(){return m().messages}function h(){s.innerHTML="";for(const[t,e]of Object.entries(l.tabs)){const n=document.createElement("li");n.className="nav-item";const a=document.createElement("button");a.className="nav-link"+(t===l.activeTabId?" active":""),a.type="button",a.innerText=e.title||"Chat",a.addEventListener("click",()=>{T(t),h()});const i=document.createElement("span");i.innerHTML="&times;",i.className="ms-2 text-muted",i.style.cursor="pointer",i.addEventListener("click",e=>{e.stopPropagation(),I(t),h()}),a.appendChild(i),n.appendChild(a),s.appendChild(n)}}function b(e){e.version=2,localStorage.setItem(t,JSON.stringify(e))}function g(t){a.innerHTML+=`\n    <div class="d-flex justify-content-end mb-2">\n      <div class="bg-success text-white p-2 rounded-4 shadow-sm" style="max-width: 70%">\n        ${r(t)}\n      </div>\n    </div>\n  `}function v(t,e="AI"){const n=function(t){const e=marked.parse(t);return DOMPurify.sanitize(e)}(t);a.innerHTML+=`\n    <div class="d-flex justify-content-start mb-2">\n      <div class="bg-light border p-2 rounded-4 shadow-sm" style="max-width: 70%">\n        ${n}\n        <div class="text-muted small text-end mt-1">\n          ${r(e)}\n        </div>\n      </div>\n    </div>\n  `}h(),p(),i.addEventListener("click",()=>{!function(){const t="tab-"+Date.now();l.tabs[t]={title:"New Chat",messages:[]},l.activeTabId=t,b(l),h(),p()}(),h()});let y=null;function f(){y&&(y.remove(),y=null)}function p(){a.innerHTML="";const t=u();for(const e of t)"user"===e.role?g(e.text):v(e.text,e.model||"AI");a.scrollTop=a.scrollHeight}function T(t){l.activeTabId=t,b(l),h(),p(),e.focus()}function I(t){1!==Object.keys(l.tabs).length?(delete l.tabs[t],l.activeTabId===t&&(l.activeTabId=Object.keys(l.tabs)[0]),b(l),h(),p()):alert("You must have at least one tab")}n.addEventListener("click",async()=>{const t=e.value.trim();if(!t)return;const s=u();g(t),e.value="";const i=m();0===i.messages.length&&(i.title=t.slice(0,20),h()),s.push({role:"user",text:t}),d(s),b(l),a.scrollTop=a.scrollHeight,y||(y=document.createElement("div"),y.className="d-flex justify-content-start mb-2",y.innerHTML='\n    <div class="bg-light border p-2 rounded-3 text-muted fst-italic"\n         style="max-width: 70%">\n      Morgan is thinking...\n    </div>\n  ',a.appendChild(y),a.scrollTop=a.scrollHeight),n.disabled=!0;try{const e=await fetch("https://chatgemini-zoxcu4jcta-uc.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:s,message:t})}),i=await e.json();f(),n.disabled=!1,v(i.message,i.model),s.push({role:"model",text:i.message,model:i.model}),d(s),b(l),a.scrollTop=a.scrollHeight}catch(t){f(),n.disabled=!1,v("_Error: failed to get response_","System")}}),e.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),n.click())}),e.addEventListener("input",()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"})})();